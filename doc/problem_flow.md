# 双足机器人路径规划问题流程与解决方案设计

## 问题定义与解决方案设计流程图

```mermaid
graph TD
    A[问题定义] --> B[状态空间建模]
    B --> C[动作空间建模]
    C --> D[约束条件建模]
    D --> E[启发式函数设计]
    E --> F1[分层路径规划]
    F1 --> F2[A*搜索算法实现]
    F2 --> G[路径生成与优化]
    
    A --> A1[输入地形图]
    A --> A2[起点与终点坐标]
    A --> A3[双足机器人物理约束]
    
    B --> B1[状态表示: x, y, rz]
    B --> B2[z, rx, ry通过地面+脚属性计算]
    
    C --> C1[步长约束: 最大40单位]
    C --> C2[双足间距: 2-10单位]
    C --> C3[转向角度: ±75°]
    C --> C4[足部法线角度: ±20°]
    
    D --> D1[地形适应性检查]
    D --> D2[稳定性约束检查]
    D --> D3[步态可行性检查]
    
    E --> E1[距离启发式: 到目标点的欧几里得距离]
    E --> E2[方向启发式: 朝向与目标方向的一致性]
    E --> E3[稳定性启发式: 落足点的稳定程度]
    
    F1 --> F11[地图缩放]
    F1 --> F12[高层路径规划]
    F1 --> F13[足部落点序列生成]
    
    F2 --> F21[OPEN和CLOSED列表管理]
    F2 --> F22[节点扩展与约束检查]
    F2 --> F23[代价函数计算: g_n + h_n]
    
    G --> G1[路径可行性验证]
    G --> G2[步态序列优化]
    G --> G3[输出落足点序列]
    
    style A fill:#ffe4c4,stroke:#333
    style F1 fill:#90ee90,stroke:#333
    style F2 fill:#90ee90,stroke:#333
    style G fill:#87ceeb,stroke:#333
```

## 详细设计说明

### 1. 问题定义阶段

#### 输入要素

- **地形图**: 1000×3000的灰度图像，表示三维地形
- **起点与终点**: 二维坐标投影
- **物理约束**:
  - 最大步长40单位
  - 双足间距2-10单位
  - 最大转向角±75°
  - 足部法线角度±20°
  - 感知范围200×200区域

### 2. 状态空间建模

#### 状态表示

使用三元组(x, y, rz)定义一个脚的状态:

- **x, y**: 脚在地面上的投影坐标
- **rz**: 脚的朝向角（绕z轴旋转）

#### 隐式计算属性

- **z**: 脚的高度，通过地面高度查询获得
- **rx, ry**: 脚的倾斜角度，通过地面法线和脚的姿态计算获得

### 3. 动作空间建模

#### 基本动作

双足机器人交替移动左右脚，每一步移动一只脚到新位置:

- 步长不超过40单位
- 转向角度不超过±75°
- 落足点必须满足稳定性约束

### 4. 约束条件建模

#### 稳定性约束

- 足部法线与重力方向夹角小于±20°

#### 步态约束

- 步长不超过40单位
- 双足间距保持在2-10单位之间
- 双足间距保持在2-10单位之间
- 转向角度不超过±75°

#### 感知约束

- 只能基于前方200×200区域的地形信息做决策

### 5. 启发式函数设计

#### 距离启发式

使用欧几里得距离估计到目标点的代价

#### 方向启发式

考虑机器人朝向与目标方向的一致性

#### 稳定性启发式

优先选择更稳定的落足点

### 6. 分层路径规划实现

#### 核心组件

- 地图缩放：将原始地图按比例缩放到较低分辨率
- 高层路径规划：在缩放地图上使用A*算法找到粗略路径
- 足部落点序列生成：根据高层路径生成具体的足部落点序列

#### 分层规划流程

1. 地图缩放：按比例因子缩放地图，采用区域内最小代价作为缩放后单元格代价值
2. 高层路径规划：在缩放地图上使用A*算法计算粗略路径
3. 足部落点序列生成：将高层路径点映射回原始地图，生成满足约束的足部序列

### 7. A*搜索算法实现

#### 核心组件

- OPEN列表：待扩展的节点
- CLOSED列表：已扩展的节点
- 代价函数：f(n) = g(n) + h(n)

#### 节点扩展过程

1. 从OPEN列表中选择f(n)最小的节点
2. 检查是否到达目标点
3. 生成可行的后续动作
4. 对每个动作检查约束条件
5. 计算新节点的代价
6. 更新OPEN和CLOSED列表

### 8. 路径生成与优化

#### 输出结果

- 一系列满足约束条件的落足点序列
- 每个落足点包含(x, y, rz)信息

#### 后处理优化

- 验证路径的全局可行性
- 优化步态序列以提高效率

## 足部与地面接触部分代码设计思路

### 基本假设

假设：在足部接触地面发生偏转时，与地面接触面积不会发生改变。

### 计算方法

基于足部rz的值，计算出足部覆盖区域，再基于足部位置，能够获取到足部覆盖地形。
利用地形信息，计算出足部接触地面的偏转角度。

### 备选方案

备选参考方案为利用凸包检测算法，计算出足部覆盖区域，再基于足部位置，能够获取到足部覆盖地形。

### 当前实现

目前实现方案为通过在区域内遍历所有单元，不断更新三点计算平面，从而计算出足部相对偏转角度。

### 详细实现思路

#### 1. 足部覆盖区域计算

- 根据足部位置(x, y)和朝向角(rz)，计算足部矩形在地面坐标系中的实际覆盖范围
- 足部尺寸为3×5cm，需要考虑旋转后在地面网格上的实际覆盖区域
- 使用几何变换计算足部四个角点在世界坐标系中的位置
- 确定足部覆盖的所有地面网格单元

#### 2. 地面数据采样

- 遍历足部覆盖区域内的所有地面网格点
- 获取每个网格点的高度值，构建局部地形点云数据
- 对于部分在足部边界上的网格点，根据覆盖面积比例进行加权处理

#### 3. 接触平面计算

- 在足部覆盖区域内采用三点迭代算法计算最佳拟合平面
- 通过最小二乘法优化平面参数，使得平面与足部覆盖区域内的地面点尽可能贴合
- 计算足部坐标系与接触平面法向量之间的夹角，作为足部倾斜角度(rx, ry)

#### 4. 稳定性评估

- 检查足部法向量与重力方向的夹角是否超过±20°的限制
- 评估足部与地面的接触面积和压力分布
- 根据地面材质和摩擦系数计算足部的滑动风险

#### 5. 凸包检测备选方案

- 使用凸包算法确定足部与地面的实际接触区域
- 通过计算接触点集的凸包来确定稳定支撑区域
- 分析凸包的几何特性，评估足部的稳定性

## 分层路径规划实现方案

### 1. 核心思想

针对双足机器人非连续、分段移动的特点，采用分层路径规划方法：

1. 高层规划：在缩放地图上使用A*算法快速找到粗略路径
2. 中层规划：将高层路径点映射回原始地图坐标
3. 底层规划：根据机器人物理约束生成具体的足部落点序列

### 2. 实现细节

#### 2.1 地图缩放

- 将原始高分辨率地图按比例因子缩放到较低分辨率
- 缩放时采用区域内最小代价作为该区域的代价值
- 这样可以保留原始地图的关键障碍物和地形特征

#### 2.2 高层路径规划

- 在缩放后的地图上使用A*算法计算粗略路径
- 以起始点和目标点在缩放地图上的对应点为搜索起点和终点
- 得到一系列路径点，这些点代表了从起点到终点的大致方向

#### 2.3 足部落点序列生成

- 将高层路径点映射回原始地图坐标系
- 根据路径点引导双足机器人逐步移动
- 交替移动左右脚，确保满足双足间距约束
- 每一步都检查步长、双足间距等物理约束条件

#### 2.4 启发式目标更新策略

- 当机器人进入下一个规划单元格时，将启发式目标切换为该单元格的中心点
- 这种策略确保机器人沿着规划路径前进，同时保持足够的灵活性来适应地形变化

### 3. 算法优势

1. **计算效率**：在缩放地图上进行路径规划大大减少了计算量
2. **路径质量**：在原始地图上进行足部序列生成保证了路径的精确性和可行性
3. **约束满足**：在足部序列生成阶段严格检查并满足双足机器人的物理约束
4. **可扩展性**：分层结构便于后续添加更复杂的约束和优化策略

## 算法设计路线

2025.9.3
预计采用A*算法计算落点

2025.9.4
确定采用接触算法，备选凸包检测，目前先实现三点迭代

2025.9.6
尝试落地A\*算法，尝试落地放缩地图，重构了部分项目结构，尝试完善足部姿态计算和接触平面拟合算法
