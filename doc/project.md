# 双足机器人在线落足点规划项目说明

## 1. 项目概述

双足机器人在不平坦的路面上运动时，其双足交替移动会受到多种因素的制约，包括步长、足平面法向量方向与重力方向夹角、观测范围、实际落足点与规划落足点的偏差等。本项目旨在解决给定起点和终点位置的情况下，如何在线规划落足点位置的问题。

## 2. 系统需求

### 2.1 输入条件

- **三维地形图**：提供机器人运动环境的三维地形信息
- **足尺寸**：3×5（单位：cm）
- **步长限制**：最大值40（单位：cm）
- **双足间距**：大于2且小于10（单位：cm）
- **观测范围**：运动方向前方200×200区域（单位：cm）
- **最大转向角**：小于±75°
- **足平面法向量与重力方向夹角**：小于±20°
- **起点和终点的投影坐标**：在二维平面上的起始和目标位置

### 2.2 输出要求

1. **双足落足点序列**：
   - 足中心位置坐标
   - 足平面法向量方向与重力方向夹角
   - 支持可视化展示

2. **轨迹长度**：
   - 计算并输出整个运动轨迹的总长度

3. **转向角曲线**：
   - 绘制机器人在运动过程中的转向角变化曲线

4. **足平面法向量方向与重力方向夹角曲线**：
   - 绘制足平面法向量方向与重力方向夹角的变化曲线

5. **实验数据分析和安全性分析**：
   - 对实验数据进行统计分析
   - 评估路径的安全性，包括稳定性、可行性等指标

## 3. 系统设计

### 3.1 对象特征及约束

#### 3.1.1 双足机器人 (Bipedal Robot)

**属性**：

- 足尺寸：3×5 cm
- 步长：最大值40 cm
- 双足间距：大于2 cm且小于10 cm
- 观测范围：运动方向前方200×200 cm区域
- 最大转向角：小于±75°
- 足平面法向量与重力方向夹角：小于±20°

**约束条件**：

- 步长不能超过40 cm
- 双足间距必须在2-10 cm范围内
- 转向角不能超过±75°
- 足平面法向量与重力方向夹角不能超过±20°

#### 3.1.2 环境地形 (Terrain)

**属性**：

- 三维地形图：提供机器人运动环境的三维地形信息
- 起点和终点的投影坐标：在二维平面上的起始和目标位置

**约束条件**：

- 机器人只能在给定的三维地形图范围内移动
- 必须从指定起点移动到指定终点

#### 3.1.3 路径规划 (Path Planning)

**属性**：

- 双足落足点序列：包含足中心位置坐标和足平面法向量方向与重力方向夹角
- 轨迹长度：整个运动轨迹的总长度
- 转向角曲线：机器人在运动过程中的转向角变化
- 足平面法向量方向与重力方向夹角曲线：足平面法向量方向与重力方向夹角的变化

**约束条件**：

- 落足点必须在机器人的观测范围内
- 落足点必须满足机器人物理限制（步长、角度等）
- 路径必须保证机器人稳定性和可行性

### 3.2 算法设计

#### 3.2.1 分层路径规划

本项目采用分层路径规划策略：

1. **高层规划**：在缩放地图上使用A*算法快速找到粗略路径
2. **中层规划**：将高层路径点映射回原始地图坐标
3. **底层规划**：根据机器人物理约束生成具体的足部落点序列

#### 3.2.2 A*搜索算法

使用改进的A*算法进行路径搜索，考虑地形代价和机器人约束：

- **启发式函数**：使用欧几里得距离作为启发式函数
- **代价函数**：综合考虑地形复杂度和移动代价
- **节点扩展**：在满足约束条件下扩展可行节点

#### 3.2.3 足部姿态计算

通过三点迭代算法计算足部与地面接触的最佳拟合平面：

- **点云采样**：获取足部覆盖区域内的地面点云数据
- **平面拟合**：使用三点迭代算法计算最佳接触平面
- **姿态评估**：计算足部法向量与重力方向的夹角

## 4. 技术实现

### 4.1 核心数据结构

- **SqDot**：二维整数坐标点，用于表示地图网格位置
- **CuDot**：三维浮点坐标点，用于表示空间位置
- **SqPlain**：二维地图结构，包含地形代价信息
- **CuPlain**：三维平面结构，用于表示接触平面

### 4.2 核心算法模块

- **A*搜索模块**：实现路径规划算法
- **地形处理模块**：处理三维地形数据
- **足部姿态模块**：计算足部与地面的接触姿态
- **约束检查模块**：验证机器人运动约束

### 4.3 测试框架

项目包含完整的测试框架，确保各模块功能正确：

- **单元测试**：针对各个模块进行独立测试
- **集成测试**：测试模块间的协同工作
- **性能测试**：评估算法性能和效率

## 5. 代码结构说明

### 5.1 源代码目录结构

```index
src/
├── aStar/              # A*算法实现
│   └── aStar.cpp       # A*算法核心实现
├── csvReader/          # CSV文件读取器
│   └── reader.cpp      # CSV数据读取实现
├── ground/             # 地面处理模块
│   └── ground.cpp      # 地面数据处理实现
├── robot/              # 机器人相关模块
│   ├── foot.cpp        # 足部相关实现
│   └── robot.cpp       # 机器人行为实现
├── utils/              # 工具模块
│   ├── geometry.cpp    # 几何计算实现
│   ├── fast_flatness.cpp # 快速平整度评估实现
│   └── scale.cpp       # 缩放功能实现
└── main.cpp            # 主程序入口
```

### 5.2 头文件目录结构

```index
include/
├── aStar/
│   └── aStar.hpp       # A*算法头文件
├── csvReader/
│   └── reader.hpp      # CSV读取器头文件
├── ground/
│   └── ground.hpp      # 地面处理头文件
├── robot/
│   ├── foot.hpp        # 足部相关头文件
│   └── robot.hpp       # 机器人相关头文件
├── utils/
│   ├── geometry.hpp    # 几何计算头文件
│   ├── fast_flatness.hpp # 快速平整度评估头文件
│   ├── scale.hpp       # 缩放功能头文件
│   ├── test_framework.hpp # 测试框架头文件
│   └── io.hpp          # IO管理头文件
└── prepare.hpp         # 预处理头文件
```

### 5.3 测试目录结构

```index
tests/
├── aStar_test.cpp      # A*算法测试
├── ground_test.cpp     # 地面处理测试
├── utils_test.cpp      # 工具模块测试
├── comparison_test.cpp # 对比测试
└── run_tests.py        # 测试运行脚本
```

## 6. 编译和构建

项目使用CMake作为构建系统，支持跨平台构建。

### 6.1 构建步骤

1. 创建构建目录：

   ```bash
   mkdir build
   cd build
   ```

2. 配置项目：

   ```bash
   cmake ..
   ```

3. 编译项目：

   ```bash
   make
   ```

### 6.2 生成的可执行文件

构建完成后会生成以下可执行文件：

- `trapla`：主程序
- `aStar_test`：A*算法测试程序
- `ground_test`：地面处理测试程序
- `utils_test`：工具模块测试程序
- `comparison_test`：对比测试程序

## 7. 运行和测试

### 7.1 运行主程序

```bash
./trapla
```

### 7.2 运行测试

在项目根目录下执行：

```bash
python scripts/run_tests.py
```

或者在Windows系统上：

```cmd
scripts\platform\windows\run_tests.bat
```
