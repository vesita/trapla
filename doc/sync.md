# 代码同步说明

在多设备开发环境中，经常需要在不同电脑之间同步未提交的代码更改。本项目提供了脚本来简化这一过程，通过 GitHub 远程同步的方式实现。

## 目录

- [脚本说明](#脚本说明)
- [使用方法](#使用方法)
- [工作流程示例](#工作流程示例)
- [使用场景](#使用场景)
- [脚本工作机制详解](#脚本工作机制详解)
- [优势](#优势)
- [注意事项](#注意事项)
- [故障排除](#故障排除)

## 脚本说明

### 1. 推送进度脚本

- 文件: [put-sync.py](../scripts/sync/put-sync.py)
- 用途: 在进度超前的 PC 上将未提交的更改推送到远程同步分支

### 2. 拉取进度脚本

- 文件: [get-sync.py](../scripts/sync/get-sync.py)
- 用途: 在落后的 PC 上从远程同步分支拉取并合并更改

## 使用方法

### 推送进度 (在进度超前的 PC 上)

运行推送脚本:

```bash
python scripts/put-sync.py
```

脚本会执行以下操作:

1. 检查当前 Git 仓库状态
2. 将所有未提交的更改添加到暂存区
3. 在当前分支上创建一个临时提交
4. 删除远程同步分支（如果存在）
5. 创建一个基于当前提交的同步分支
6. 将同步分支推送到远程仓库
7. 切换回原分支并撤销临时提交
8. 删除本地同步分支

### 拉取进度 (在落后的 PC 上)

运行拉取脚本:

```bash
python scripts/get-sync.py
```

脚本会执行以下操作:

1. 检查本地是否有未提交的更改
2. 如果有本地更改，自动保存到备份分支（适用于落后端的本地更改）
3. 删除上一次的备份分支（如果存在）
4. 创建新的备份分支以保存当前状态
5. 获取远程更新
6. 检查默认远程同步分支是否存在
7. 如果默认分支存在，直接使用它进行同步
8. 如果默认分支不存在，显示所有可用的同步分支供用户选择
9. 检出选中的同步分支并在原分支上合并更改
10. 重置合并提交，使工作区回到有更改但未提交的状态
11. 自动清理本地同步分支
12. 如果使用的是默认分支，还会自动清理远程同步分支

## 工作流程示例

1. 在 PC-A (进度超前) 上运行:

   ```bash
   python scripts/put-sync.py
   ```

2. 在 PC-B (进度落后) 上运行:

   ```bash
   python scripts/get-sync.py
   ```

## 使用场景

### 一人多设备开发

这是脚本设计的主要使用场景。例如，开发者在办公室编写代码，但尚未提交，回家后需要继续在同一任务上工作。这时可以使用这些脚本来同步未提交的更改。

### 临时设备切换

当主要开发设备出现问题需要临时切换到备用设备时，可以使用这些脚本快速同步工作进度。

### 网络不稳定的环境

在某些网络不稳定的环境中，可能无法直接推送到主分支，但可以通过这些脚本将更改临时保存到远程仓库，待网络恢复后再处理。

## 脚本工作机制详解

### 分支命名策略

脚本使用 `sync-of-{github_username}` 的命名方式创建同步分支，这种命名方式有以下优点：

1. **唯一性**：每个用户的分支名都是唯一的，避免了多人协作时的分支冲突
2. **可识别性**：通过分支名可以快速识别该分支属于哪个用户
3. **自动清理**：因为分支名与用户名绑定，脚本可以安全地自动删除远程分支

### 备份机制

get-sync.py 脚本具有自动备份功能，当拉取端存在本地更改时：

1. 自动将本地更改保存到 `backup_{timestamp}` 分支
2. 删除上一次的备份分支（确保只有一个最新的备份）
3. 同步完成后提示用户处理备份分支中的更改

### 错误处理与恢复

脚本具有完善的错误处理机制：

1. **网络超时重试**：对于推送和删除远程分支等网络操作，脚本会自动重试最多3次
2. **失败回滚**：当操作失败时，脚本会尽力恢复到操作前的状态
3. **手动清理提示**：当自动清理失败时，会提供手动清理的命令

### 安全性考虑

1. **只操作同步分支**：脚本只操作以 `sync-of-` 开头的分支，不会影响主分支和其他功能分支
2. **验证分支名**：脚本会对生成的分支名进行验证，确保符合 Git 规范
3. **权限保护**：只有使用默认分支（与用户名匹配）时才会自动删除远程分支，防止误删他人分支

## 优势

1. **自动清理**: 脚本会自动清理本地和远程同步分支，避免分支污染
2. **远程同步**: 通过 GitHub 实现真正的远程同步
3. **不污染主分支**: 所有操作都在同步分支上进行，不会污染主分支历史记录
4. **个性化分支名**: 使用基于GitHub用户名的同步分支名（sync-of-{github_username}），避免多用户环境下的分支冲突
5. **状态一致性**: 拉取端在同步后与推送端推送前具有相同的工作区状态（有更改但未提交）
6. **安全性增强**: 增加了错误处理和验证机制，提高脚本的健壮性
7. **自动备份**: 自动将落后端的本地更改保存到备份分支，防止意外丢失
8. **自动管理**: 自动删除上一次的备份分支，避免备份分支积累
9. **适用性强**: 特别适用于一人多设备开发场景，其中超前端是在落后端基础上继续开发的情况
10. **无交互操作**: 在正常情况下不需要用户交互，直接采用默认分支进行同步
11. **避免冲突**: 使用GitHub用户名作为同步分支的一部分，避免不同用户之间分支冲突
12. **现代Git命令**: 使用 `git switch` 替代 `git checkout`，语义更清晰，操作更安全
13. **智能分支选择**: 当默认分支不存在时，提供用户友好的分支选择界面
14. **非默认分支保护**: 使用非默认分支时不会自动删除远程分支，防止误删

## 注意事项

1. 确保在 Git 仓库根目录下运行脚本
2. 确保有网络连接以便推送和拉取更改
3. 确保有适当的权限来创建分支和推送代码
4. 确保两台 PC 使用相同的远程仓库 (GitHub)
5. 如果合并过程中出现冲突，需要手动解决后再运行脚本
6. 脚本会自动验证分支名称的有效性，避免非法操作
7. 落后端的本地更改会自动保存到备份分支，主分支直接采用超前端的更改
8. 每次同步时会自动删除上一次的备份分支，确保只有一个最新的备份
9. 同步分支会在每次拉取操作后被自动删除，确保下次同步时使用最新的更改
10. 当使用非默认分支进行同步时，远程分支不会被自动删除，需要手动清理
11. 脚本优先使用默认分支以保持向后兼容性，在默认分支不存在时才需要用户交互
12. 脚本使用指数退避策略处理网络超时，提高在不稳定网络环境下的成功率

## 故障排除

### 常见问题

1. **推送失败**: 检查网络连接和远程仓库权限
2. **拉取失败**: 确认远程同步分支存在
3. **合并冲突**: 需要手动解决冲突后重新运行脚本
4. **分支删除失败**: 可以手动删除分支 `git push origin --delete sync-of-{github_username}`

### 手动清理

如果脚本执行过程中断，可能需要手动清理:

```bash
# 删除本地分支
git branch -D sync-of-{github_username}

# 删除远程分支
git push origin --delete sync-of-{github_username}

# 恢复备份的更改（如果需要）
git checkout backup_xxxxxx
```

### 恢复备份的更改

如果需要恢复之前备份的更改，可以使用以下步骤:

1. 切换到备份分支:

   ```bash
   git checkout backup_xxxxxx
   ```

2. 查看备份的更改:

   ```bash
   git diff HEAD..main
   ```

3. 将更改合并回主分支:

   ```bash
   git checkout main
   git merge backup_xxxxxx
   ```

4. 删除备份分支:

   ```bash
   git branch -D backup_xxxxxx
   ```
