# 代码同步说明

在多设备开发环境中，经常需要在不同电脑之间同步未提交的代码更改。本项目提供了脚本来简化这一过程，通过 GitHub 远程同步的方式实现。

## 脚本说明

### 1. 推送进度脚本

- 文件: [scripts/put-sync.py](file:///f:/library/Code/may/scripts/put-sync.py)
- 用途: 在进度超前的 PC 上将未提交的更改推送到远程同步分支

### 2. 拉取进度脚本

- 文件: [scripts/get-sync.py](file:///f:/library/Code/may/scripts/get-sync.py)
- 用途: 在落后的 PC 上从远程同步分支拉取并合并更改

## 使用方法

### 推送进度 (在进度超前的 PC 上)

运行推送脚本:

```bash
python scripts/put-sync.py
```

脚本会执行以下操作:

1. 检查当前 Git 仓库状态
2. 将所有未提交的更改添加到暂存区
3. 在当前分支上创建一个临时提交
4. 删除远程同步分支（如果存在）
5. 创建一个基于当前提交的同步分支
6. 将同步分支推送到远程仓库
7. 切换回原分支并撤销临时提交
8. 删除本地同步分支

### 拉取进度 (在落后的 PC 上)

运行拉取脚本:

```bash
python scripts/get-sync.py
```

脚本会执行以下操作:

1. 检查本地是否有未提交的更改
2. 如果有本地更改，自动保存到备份分支（适用于落后端的本地更改）
3. 删除上一次的备份分支（如果存在）
4. 创建新的备份分支以保存当前状态
5. 获取远程更新
6. 检查远程同步分支是否存在
7. 检出同步分支并在原分支上合并更改
8. 重置合并提交，使工作区回到有更改但未提交的状态
9. 自动清理本地和远程同步分支

## 工作流程示例

1. 在 PC-A (进度超前) 上运行:

   ```bash
   python scripts/put-sync.py
   ```

2. 在 PC-B (进度落后) 上运行:

   ```bash
   python scripts/get-sync.py
   ```

## 优势

1. **自动清理**: 脚本会自动清理本地和远程同步分支，避免分支污染
2. **远程同步**: 通过 GitHub 实现真正的远程同步
3. **不污染主分支**: 所有操作都在同步分支上进行，不会污染主分支历史记录
4. **个性化分支名**: 使用基于GitHub用户名的同步分支名（sync-of-{github_username}），避免多用户环境下的分支冲突
5. **状态一致性**: 拉取端在同步后与推送端推送前具有相同的工作区状态（有更改但未提交）
6. **安全性增强**: 增加了错误处理和验证机制，提高脚本的健壮性
7. **自动备份**: 自动将落后端的本地更改保存到备份分支，防止意外丢失
8. **自动管理**: 自动删除上一次的备份分支，避免备份分支积累
9. **适用性强**: 特别适用于一人多设备开发场景，其中超前端是在落后端基础上继续开发的情况
10. **无交互操作**: 不需要用户确认是否丢弃本地更改，直接采用超前端的更改
11. **避免冲突**: 使用GitHub用户名作为同步分支的一部分，避免不同用户之间分支冲突
12. **现代Git命令**: 使用 `git switch` 替代 `git checkout`，语义更清晰，操作更安全

## 注意事项

1. 确保在 Git 仓库根目录下运行脚本
2. 确保有网络连接以便推送和拉取更改
3. 确保有适当的权限来创建分支和推送代码
4. 确保两台 PC 使用相同的远程仓库 (GitHub)
5. 如果合并过程中出现冲突，需要手动解决后再运行脚本
6. 脚本会自动验证分支名称的有效性，避免非法操作
7. 落后端的本地更改会自动保存到备份分支，主分支直接采用超前端的更改
8. 每次同步时会自动删除上一次的备份分支，确保只有一个最新的备份
9. 同步分支会在每次拉取操作后被自动删除，确保下次同步时使用最新的更改

## 故障排除

### 常见问题

1. **推送失败**: 检查网络连接和远程仓库权限
2. **拉取失败**: 确认远程同步分支存在
3. **合并冲突**: 需要手动解决冲突后重新运行脚本
4. **分支删除失败**: 可以手动删除分支 `git push origin --delete sync-of-{github_username}`

### 手动清理

如果脚本执行过程中断，可能需要手动清理:

```bash
# 删除本地分支
git branch -D sync-of-{github_username}

# 删除远程分支
git push origin --delete sync-of-{github_username}

# 恢复备份的更改（如果需要）
git checkout backup_xxxxxx
```

### 恢复备份的更改

如果需要恢复之前备份的更改，可以使用以下步骤:

1. 切换到备份分支:

   ```bash
   git checkout backup_xxxxxx
   ```

2. 查看备份的更改:

   ```bash
   git diff HEAD..main
   ```

3. 将更改合并回主分支:

   ```bash
   git checkout main
   git merge backup_xxxxxx
   ```

4. 删除备份分支:

   ```bash
   git branch -D backup_xxxxxx
   ```